service: insight-forge

frameworkVersion: '3'

provider:
  name: aws
  runtime: python3.11
  stage: ${opt:stage, 'dev'}
  region: ${opt:region, 'us-east-1'}
  memorySize: 256
  timeout: 60
  environment:
    DYNAMODB_TABLE: ${self:custom.tableName}
    S3_BUCKET: ${self:custom.bucketName}
    STAGE: ${self:provider.stage}
  iam:
    role:
      statements:
        - Effect: Allow
          Action:
            - comprehend:DetectSentiment
            - comprehend:DetectKeyPhrases
          Resource: '*'
        - Effect: Allow
          Action:
            - s3:GetObject
            - s3:PutObject
          Resource:
            - arn:aws:s3:::${self:custom.bucketName}/*
        - Effect: Allow
          Action:
            - dynamodb:PutItem
            - dynamodb:GetItem
            - dynamodb:Scan
            - dynamodb:Query
            - dynamodb:UpdateItem
          Resource:
            - !GetAtt SentimentResultsTable.Arn

  httpApi:
    cors:
      allowedOrigins:
        - http://localhost:3000
        - http://localhost:3001
      allowedHeaders:
        - Content-Type
        - Authorization
      allowedMethods:
        - GET
        - POST
        - OPTIONS

custom:
  bucketName: insight-forge-uploads-${self:provider.stage}
  tableName: SentimentResults-${self:provider.stage}

functions:
  processCSV:
    handler: handlers/process_csv.handler
    description: Processes uploaded CSV files through Amazon Comprehend
    timeout: 300
    memorySize: 512
    events:
      - s3:
          bucket: ${self:custom.bucketName}
          event: s3:ObjectCreated:*
          rules:
            - suffix: .csv

  getMetrics:
    handler: handlers/api_handler.get_metrics
    description: Returns aggregated sentiment metrics
    events:
      - httpApi:
          path: /api/metrics
          method: GET

  getReviews:
    handler: handlers/api_handler.get_reviews
    description: Returns filtered and sorted reviews
    events:
      - httpApi:
          path: /api/reviews
          method: GET

  getUploadUrl:
    handler: handlers/api_handler.get_upload_url
    description: Generates a presigned S3 upload URL
    events:
      - httpApi:
          path: /api/upload-url
          method: GET

resources:
  Resources:
    SentimentResultsTable:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: ${self:custom.tableName}
        BillingMode: PAY_PER_REQUEST
        AttributeDefinitions:
          - AttributeName: reviewId
            AttributeType: S
          - AttributeName: sentiment
            AttributeType: S
        KeySchema:
          - AttributeName: reviewId
            KeyType: HASH
        GlobalSecondaryIndexes:
          - IndexName: SentimentIndex
            KeySchema:
              - AttributeName: sentiment
                KeyType: HASH
              - AttributeName: reviewId
                KeyType: RANGE
            Projection:
              ProjectionType: ALL

  Outputs:
    ApiUrl:
      Description: URL of the API Gateway
      Value: !Sub 'https://${HttpApi}.execute-api.${AWS::Region}.amazonaws.com'
    BucketName:
      Description: Name of the S3 upload bucket
      Value: ${self:custom.bucketName}
    TableName:
      Description: Name of the DynamoDB table
      Value: ${self:custom.tableName}
